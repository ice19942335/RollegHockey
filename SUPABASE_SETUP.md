# Настройка Supabase для RollegHockey

## Шаг 1: Выполнение SQL миграции

1. Откройте [Supabase Dashboard](https://supabase.com/dashboard)
2. Выберите ваш проект
3. Перейдите в раздел **SQL Editor** (в боковом меню)
4. Откройте файл `supabase-migration.sql` из корня проекта
5. Скопируйте весь SQL код из файла
6. Вставьте код в SQL Editor
7. Нажмите кнопку **Run** (или `Ctrl+Enter`)

**Важно:** Убедитесь, что скрипт выполнился без ошибок. Должны быть созданы:
- Таблица `rolleg_tournaments`
- Таблица `rolleg_teams`
- Таблица `rolleg_games`
- Индексы для оптимизации
- RLS политики для публичного доступа

## Шаг 2: Проверка подключения

1. Установите зависимости:
   ```bash
   npm install
   ```

2. Запустите приложение:
   ```bash
   npm run dev
   ```

3. Откройте в браузере:
   ```
   http://localhost:5173/test-supabase
   ```

4. Проверьте, что подключение успешно

## Шаг 3: Тестирование функциональности

После успешного подключения протестируйте:

1. **Создание турнира:**
   - Перейдите на главную страницу
   - Нажмите "Создать турнир"
   - Заполните форму и создайте турнир

2. **Добавление команд:**
   - Откройте созданный турнир
   - Добавьте несколько команд

3. **Добавление игр:**
   - Добавьте игры между командами
   - Проверьте сохранение счета

4. **Удаление турнира:**
   - Вернитесь на главную страницу
   - Удалите тестовый турнир
   - Убедитесь, что все связанные данные удалены

## Структура базы данных

### Таблица `rolleg_tournaments`
- `id` (TEXT, PRIMARY KEY) - уникальный ID турнира
- `name` (TEXT) - название турнира
- `startDate` (DATE) - дата начала
- `endDate` (DATE) - дата окончания
- `description` (TEXT) - описание
- `createdAt` (TIMESTAMP) - дата создания

### Таблица `rolleg_teams`
- `id` (TEXT, PRIMARY KEY) - ID команды
- `tournamentId` (TEXT, FOREIGN KEY) - ID турнира
- `name` (TEXT) - название команды
- `logo` (TEXT) - эмодзи/логотип
- `color` (TEXT) - цвет команды

### Таблица `rolleg_games`
- `id` (TEXT, PRIMARY KEY) - ID игры
- `tournamentId` (TEXT, FOREIGN KEY) - ID турнира
- `homeTeamId` (TEXT, FOREIGN KEY) - ID домашней команды
- `awayTeamId` (TEXT, FOREIGN KEY) - ID гостевой команды
- `homeScore` (INTEGER) - счет домашней команды
- `awayScore` (INTEGER) - счет гостевой команды
- `gameType` (TEXT) - тип игры (regular, shootout)
- `date` (TEXT) - дата игры
- `pending` (BOOLEAN) - флаг ожидающей игры

## Безопасность

Все таблицы настроены с Row Level Security (RLS) для публичного доступа:
- **SELECT** - разрешен всем (anon)
- **INSERT** - разрешен всем (anon)
- **UPDATE** - разрешен всем (anon)
- **DELETE** - разрешен всем (anon)

**Важно:** Это означает, что любой пользователь может читать и изменять данные. Если в будущем понадобится аутентификация, нужно будет обновить RLS политики.

## Каскадное удаление

При удалении турнира автоматически удаляются:
- Все связанные команды (teams)
- Все связанные игры (games)

Это реализовано через `ON DELETE CASCADE` во внешних ключах.

## Устранение неполадок

### Ошибка подключения
- Проверьте, что URL и anon key в `src/config/supabase.js` правильные
- Убедитесь, что проект в Supabase активен

### Ошибка "table does not exist"
- Убедитесь, что SQL скрипт выполнен полностью
- Проверьте в Supabase Dashboard -> Table Editor, что таблицы созданы:
  - `rolleg_tournaments`
  - `rolleg_teams`
  - `rolleg_games`

### Ошибка прав доступа (RLS)
- Проверьте, что RLS политики созданы
- В Supabase Dashboard -> Authentication -> Policies проверьте наличие политик

### Данные не сохраняются
- Проверьте консоль браузера на наличие ошибок
- Убедитесь, что `tournamentId` передается корректно

## После успешной миграции

После того, как все работает корректно, можно:

1. Удалить тестовый компонент `src/components/SupabaseConnectionTest.jsx`
2. Удалить маршрут `/test-supabase` из `src/App.jsx`
3. Удалить тестовые файлы (опционально):
   - `src/components/SupabaseConnectionTest.jsx` - тестовый компонент подключения
   - `src/utils/googleSheets.js` - старый код для Google Sheets (больше не используется)
   - `src/config/googleSheets.js` - старая конфигурация (больше не используется)
